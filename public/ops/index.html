<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SSOT • Operaciones</title>
  <link rel="preload" href="/fonts/Inter-Variable.woff2" as="font" type="font/woff2" crossorigin>
  <style>/* CRITICAL CSS START */*{box-sizing:border-box;margin:0;padding:0}body{font-family:var(--font-sans,'Inter',system-ui,-apple-system,sans-serif);font-size:14px;line-height:1.5;color:var(--text,#111);background:var(--bg,#f6f7f9);min-height:100vh;display:flex;flex-direction:column}:root{--bg:#f6f7f9;--surface:#fff;--text:#111;--text-secondary:#6b7280;--border:#e5e7eb;--brand:#111;--accent:#0f766e;--danger:#b91c1c;--success:#28a745;}@media(prefers-color-scheme:dark){:root{--bg:#0b0c0f;--surface:#111418;--text:#f3f4f6;--text-secondary:#9ca3af;--border:#1f2937;--brand:#e5e7eb;--accent:#14b8a6;--danger:#ef4444;}}.dark{--bg:#0b0c0f;--surface:#111418;--text:#f3f4f6;--text-secondary:#9ca3af;--border:#1f2937;--brand:#e5e7eb;--accent:#14b8a6;--danger:#ef4444;}header{background:var(--brand);color:#fff;padding:1rem;position:sticky;top:0;z-index:100;box-shadow:0 2px 4px rgba(0,0,0,0.1)}header h1{font-size:1.25rem;font-weight:600;margin-bottom:1rem}.controls{display:flex;flex-wrap:wrap;gap:0.5rem;align-items:center}.filter-btn{padding:0.5rem 1rem;background:rgba(255,255,255,0.1);color:#fff;border:1px solid rgba(255,255,255,0.2);border-radius:4px;cursor:pointer;font-size:0.875rem}.filter-btn.active{background:#fff;color:var(--brand);border-color:#fff}.btn-export{background:var(--success);color:#fff;border-color:var(--success)}main{flex:1;padding:1rem;max-width:1400px;margin:0 auto;width:100%}.kpi-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;margin-bottom:2rem}.kpi-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:1rem;box-shadow:0 1px 3px rgba(0,0,0,0.05)}.kpi-label{font-size:0.75rem;color:var(--text-secondary);text-transform:uppercase;font-weight:600;margin-bottom:0.25rem}.kpi-value{font-size:1.5rem;font-weight:700;color:var(--text)}.kpi-value.ok{color:var(--success)}.kpi-value.blocked{color:var(--danger)}#projects-section h2{font-size:1.25rem;margin-bottom:1rem}.table-wrapper{overflow-x:auto;background:var(--surface);border:1px solid var(--border);border-radius:8px}#langSelector{padding:0.5rem;background:#fff;color:var(--brand);border:1px solid var(--border);border-radius:4px;font-size:0.875rem}@media(min-width:768px){header h1{font-size:1.5rem}.kpi-grid{grid-template-columns:repeat(4,1fr)}}/* CRITICAL CSS END */</style>
  <link rel="stylesheet" href="/shared/tokens.css">
  <link rel="stylesheet" href="/ops/styles.css">
</head>
<body>
  <header>
    <h1 data-i18n="ops.title">SSOT • Operaciones</h1>
    <div class="controls">
      <select id="project-filter">
        <option value="all" data-i18n="ops.allProjects">Todos los proyectos</option>
      </select>
      <div class="status-filter">
        <button class="filter-btn active" data-status="all" data-i18n="ops.all">Todos</button>
        <button class="filter-btn" data-status="ok">PASS</button>
        <button class="filter-btn" data-status="blocked">FAIL</button>
      </div>
      <!-- Date range controls -->
      <div class="date-controls">
        <button class="range-btn" data-range="7d" data-i18n="ops.range.7d">7d</button>
        <button class="range-btn active" data-range="30d" data-i18n="ops.range.30d">30d</button>
        <button class="range-btn" data-range="90d" data-i18n="ops.range.90d">90d</button>
        <button class="range-btn" data-range="ytd" data-i18n="ops.range.ytd">YTD</button>
        <button class="range-btn" data-range="all" data-i18n="ops.range.all">Todo</button>
        <button class="range-btn" data-range="custom" data-i18n="ops.range.custom">Custom</button>
      </div>
      <div class="date-inputs hidden" id="custom-dates">
        <input type="date" id="date-from" aria-label="From">
        <input type="date" id="date-to" aria-label="To">
      </div>
      <label class="grouping-toggle">
        <input type="checkbox" id="group-global">
        <span data-i18n="ops.groupGlobal">Agrupar Global</span>
      </label>
      <button id="navWarehouse" class="btn" data-i18n="wh.warehouse">Almacén</button>
      <button id="export-csv" class="btn btn-export" data-i18n="ops.exportCSV">📥 Export CSV</button>
      <button id="export-patch" class="btn hidden" data-i18n="wh.exportPatch">Export JSON</button>
      <select id="langSelector" aria-label="Language">
        <option value="es">ES</option>
        <option value="en">EN</option>
      </select>
      <button id="themeToggle" aria-label="Cambiar tema" class="btn-icon">
        <!-- Muestra luna en tema claro -->
        <svg class="icon icon-moon" viewBox="0 0 24 24" aria-hidden="true">
          <path fill="currentColor" d="M21 12.8A9 9 0 1 1 11.2 3a7 7 0 0 0 9.8 9.8z"/>
        </svg>
        <!-- Muestra sol en tema oscuro -->
        <svg class="icon icon-sun" viewBox="0 0 24 24" aria-hidden="true">
          <g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="5"/>
            <path d="M12 1v3M12 20v3M4.2 4.2l2.1 2.1M17.7 17.7l2.1 2.1M1 12h3M20 12h3M4.2 19.8l2.1-2.1M17.7 6.3l2.1-2.1"/>
          </g>
        </svg>
      </button>
    </div>
  </header>
  
  <main>
    <!-- Trends Section -->
    <section id="trends-section" class="trends-container">
      <h2 data-i18n="ops.trends">Tendencias</h2>
      <div class="trends-grid">
        <div class="trend-card">
          <label data-i18n="ops.trends.costP50">Costo P50</label>
          <svg id="trend-cost-p50" class="sparkline-svg" viewBox="0 0 300 60" aria-label="Tendencia de Costo P50">
            <!-- Populated by JS -->
          </svg>
        </div>
        <div class="trend-card">
          <label data-i18n="ops.trends.costP80">Costo P80</label>
          <svg id="trend-cost-p80" class="sparkline-svg" viewBox="0 0 300 60" aria-label="Tendencia de Costo P80">
            <!-- Populated by JS -->
          </svg>
        </div>
        <div class="trend-card">
          <label data-i18n="ops.trends.waste">Merma (%)</label>
          <svg id="trend-waste" class="sparkline-svg" viewBox="0 0 300 60" aria-label="Tendencia de Merma">
            <!-- Populated by JS -->
          </svg>
        </div>
        <div class="trend-card">
          <label data-i18n="ops.trends.qcPass">QC Pass Rate</label>
          <svg id="trend-qc" class="sparkline-svg" viewBox="0 0 300 60" aria-label="Tendencia de QC Pass Rate">
            <!-- Populated by JS -->
          </svg>
        </div>
      </div>
    </section>
    
    <!-- KPI Cards -->
    <section id="kpi-cards" class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-label" data-i18n="ops.costP50">Costo P50</div>
        <div class="kpi-value" id="kpi-cost-p50">—</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label" data-i18n="ops.costP80">Costo P80</div>
        <div class="kpi-value" id="kpi-cost-p80">—</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label" data-i18n="ops.timelineP50">Plazo P50</div>
        <div class="kpi-value" id="kpi-timeline-p50">—</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label" data-i18n="ops.realWaste">Merma Real</div>
        <div class="kpi-value" id="kpi-waste">—</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Sheets</div>
        <div class="kpi-value" id="kpi-sheets">—</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label" data-i18n="ops.qcGate">QC Gate</div>
        <div class="kpi-value" id="kpi-qc">—</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label" data-i18n="ops.bomPieces">Piezas BOM</div>
        <div class="kpi-value" id="kpi-pieces">—</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label" data-i18n="ops.projects">Proyectos</div>
        <div class="kpi-value" id="kpi-projects">—</div>
      </div>
    </section>
    
    <!-- Projects Table -->
    <section id="projects-section">
      <h2 data-i18n="ops.projects">Proyectos</h2>
      <div class="table-wrapper">
        <table id="projects-table">
          <thead>
            <tr>
              <th data-sort="projectId">ID</th>
              <th data-sort="cliente" data-i18n="ops.client">Cliente</th>
              <th data-sort="cost_p50" data-i18n="ops.costP50">Costo P50</th>
              <th data-i18n="ops.deltaTarget">Δ Meta</th>
              <th data-sort="cost_p80" data-i18n="ops.costP80">Costo P80</th>
              <th data-sort="timeline_days_p50" data-i18n="ops.timeline">Plazo</th>
              <th data-sort="waste_pct" data-i18n="ops.waste">Merma</th>
              <th data-i18n="ops.deltaWaste">Δ Meta</th>
              <th data-sort="sheets_used">Sheets</th>
              <th data-sort="qc_overall_pass">QC</th>
              <th data-sort="pieces_count" data-i18n="ops.pieces">Piezas</th>
              <th data-sort="generated_at" data-i18n="ops.updated">Actualizado</th>
            </tr>
          </thead>
          <tbody id="projects-tbody">
            <!-- Populated by JS -->
          </tbody>
        </table>
      </div>
    </section>
    
    <!-- Project Detail -->
    <section id="project-detail" class="hidden">
      <h2 id="detail-title" data-i18n="ops.projectDetail">Detalle del Proyecto</h2>
      
      <div class="detail-grid">
        <!-- QC Phases -->
        <div class="detail-card">
          <h3 data-i18n="ops.qcPhases">QC Fases</h3>
          <div id="qc-phases">
            <!-- Populated by JS -->
          </div>
        </div>
        
        <!-- Panels Info -->
        <div class="detail-card">
          <h3 data-i18n="ops.panels">Paneles</h3>
          <div id="panels-info">
            <!-- Populated by JS -->
          </div>
        </div>
        
        <!-- Hardware -->
        <div class="detail-card">
          <h3 data-i18n="ops.hardware">Herrajes</h3>
          <div id="hardware-info">
            <!-- Populated by JS -->
          </div>
        </div>
        
        <!-- Trends -->
        <div class="detail-card">
          <h3 data-i18n="ops.trends">Tendencias</h3>
          <div class="trend-item">
            <label>Costo P50</label>
            <div id="trend-cost" class="sparkline"></div>
          </div>
          <div class="trend-item">
            <label>Merma %</label>
            <div id="trend-waste" class="sparkline"></div>
          </div>
        </div>
      </div>
      
      <button class="btn btn-back" onclick="showProjectsList()" data-i18n="ops.backToList">← Volver a lista</button>
    </section>
    
    <!-- Warehouse Section -->
    <section id="warehouse-section" class="hidden">
      <h2 data-i18n="wh.inventory">Inventario de Remanentes</h2>
      
      <!-- KPIs -->
      <div id="warehouse-kpis" class="kpi-grid">
        <!-- Populated by JS -->
      </div>
      
      <!-- Filters -->
      <div class="warehouse-filters">
        <input type="text" id="filter-search" placeholder="Buscar ID/QR" data-i18n-placeholder="wh.searchPlaceholder">
        <input type="text" id="filter-material" placeholder="Material" data-i18n-placeholder="wh.filterMaterial">
        <input type="number" id="filter-thickness" placeholder="Espesor" data-i18n-placeholder="wh.filterThickness">
        <select id="filter-status">
          <option value="all" data-i18n="common.all">Todos</option>
          <option value="available" data-i18n="wh.available">Disponible</option>
          <option value="reserved" data-i18n="wh.reserved">Reservado</option>
          <option value="consumed" data-i18n="wh.consumed">Consumido</option>
          <option value="scrap" data-i18n="wh.scrap">Descarte</option>
        </select>
        <input type="text" id="filter-location" placeholder="Ubicación" data-i18n-placeholder="wh.filterLocation">
      </div>
      
      <!-- Quick Actions -->
      <div class="warehouse-actions">
        <button class="btn btn-primary" onclick="warehouse.newOffcut()" data-i18n="wh.newOffcut">Nuevo</button>
        <button class="btn" onclick="warehouse.reserveOffcut()" data-i18n="wh.reserve">Reservar</button>
        <button class="btn" onclick="warehouse.consumeOffcut()" data-i18n="wh.consume">Consumir</button>
        <button class="btn" onclick="warehouse.moveOffcut()" data-i18n="wh.move">Mover</button>
        <button class="btn" onclick="warehouse.printLabels()" data-i18n="wh.printLabels">Imprimir Etiquetas</button>
      </div>
      
      <!-- Inventory Table -->
      <div class="table-wrapper">
        <table id="warehouse-table">
          <thead>
            <tr>
              <th><input type="checkbox" id="select-all-offcuts"></th>
              <th data-i18n="wh.id">ID</th>
              <th data-i18n="wh.material">Material</th>
              <th data-i18n="wh.thickness">Espesor</th>
              <th data-i18n="wh.dimensions">Dimensiones</th>
              <th data-i18n="wh.area">Área</th>
              <th data-i18n="wh.location">Ubicación</th>
              <th data-i18n="wh.status">Estado</th>
              <th data-i18n="wh.origin">Origen</th>
              <th data-i18n="wh.updated">Actualizado</th>
            </tr>
          </thead>
          <tbody id="warehouse-tbody">
            <!-- Populated by JS -->
          </tbody>
        </table>
      </div>
    </section>
    
    <!-- Labels Print View -->
    <section id="labels-section" class="hidden">
      <div id="labels-container">
        <!-- Populated by JS -->
      </div>
    </section>
  </main>
  
  <!-- Modal for warehouse actions -->
  <div id="warehouse-modal" class="modal hidden">
    <!-- Populated by JS -->
  </div>
  
  <footer>
    <small>Dashboard Operativo v1 • Read-only</small>
  </footer>
  
  <script src="/ops/sw-register.js" defer></script>
  <script src="/shared/i18n.js" defer></script>
  <script src="/shared/theme.js" defer></script>
  <script src="/ops/ops-trends.js" defer></script>
  <script src="/ops/warehouse.js" defer></script>
  <script src="/ops/warehouse-labels.js" defer></script>
  <script src="/ops/ops.js" defer></script>
</body>
</html>